---
name: 3Dモードグリッド設定反映テスト作成（修正版）
overview: "`Grid3DLayoutRenderer`が`GridLayout`ではなく`Grid3DControls`（`grid3DConfigAtom`）に同期するように実装を変更し、それに合わせたテストを作成します。"
todos:
  - id: "1"
    content: edit-app.tsxでgrid3DConfigAtomからGridLayoutを生成するロジックを実装
    status: pending
  - id: "2"
    content: セル配置情報とgrid3DConfigをマージするヘルパー関数を作成
    status: pending
  - id: "3"
    content: setLayoutコールバックを修正（セル配置情報のみを保存）
    status: pending
    dependencies:
      - "1"
      - "2"
  - id: "4"
    content: 既存のテストファイルを修正（Grid3DConfigに同期することを検証）
    status: pending
    dependencies:
      - "1"
      - "2"
      - "3"
  - id: "5"
    content: すべてのテストケースを修正（Max Width、Columns、Row Height、Bordered）
    status: pending
    dependencies:
      - "4"
  - id: "6"
    content: テストを実行し、すべてのテストが成功することを確認
    status: pending
    dependencies:
      - "5"
---

# 3Dモードのグリッド設定反映テストの作成（修正版）

## 現状の確認

コードベースを確認した結果、以下のことが判明しました：

1. **現在の実装の問題点**:

- `Grid3DRenderer`（そして`Grid3DLayoutRenderer`）は`layoutState.layoutData.grid`（`GridLayout`型）から`layout` propを受け取っている（```383:386:src/core/edit-app.tsx```）
- `Grid3DControls`は`grid3DConfigAtom`（`Grid3DConfig`型）を操作している（```347:347:src/core/edit-app.tsx```）
- この2つは同期されていないため、`Grid3DControls`の設定変更が`Grid3DLayoutRenderer`に反映されない

2. **ユーザーの要求**:

- `Grid3DLayoutRenderer`は`GridLayout`（`layoutState.layoutData.grid`）に同期するのではなく、`Grid3DControls`（`grid3DConfigAtom`）に同期すべき

## 実装方針（修正版）

### 1. `edit-app.tsx`の修正

`Grid3DRenderer`に渡す`layout`を、`layoutState.layoutData.grid`からではなく、`grid3DConfigAtom`から生成するように変更します。実装内容：

- `grid3DConfigAtom`から`Grid3DConfig`を取得
- `Grid3DConfig`を`GridLayout`に変換するヘルパー関数を作成
- セル配置情報（`cells`、`scrollableCells`、`cellSide`）は`layoutState.layoutData.grid`から取得し、設定値（`columns`、`rowHeight`、`maxWidth`、`bordered`）は`grid3DConfig`から取得してマージ
- `setLayout`コールバックでは、セル配置情報のみを`layoutState.layoutData.grid`に保存（設定値は`grid3DConfigAtom`に保存されるため）

### 2. 統合テストの作成（修正版）

新しいテストファイル `src/components/editor/renderers/3d-layout/__tests__/grid-3d-config-integration.test.tsx` を作成します。

#### テストの構成

1. **セットアップ**

- Jotai ProviderとStoreのセットアップ
- 必要なモックの設定（Three.js、CSS2DRenderer関連）
- `Grid3DControls`と`Grid3DLayoutRenderer`をレンダリング

2. **テストケース**

- **Max Width (px)の反映**
    - `Grid3DControls`でMax Widthを変更
    - `grid3DConfigAtom`が更新されることを確認
    - `Grid3DLayoutRenderer`に渡される`layout` propが更新されることを確認
    - 実際のDOM要素の`maxWidth`スタイルが反映されていることを確認
- **Columnsの反映**
    - `Grid3DControls`でColumnsを変更
    - `Grid3DLayoutRenderer`の`ReactGridLayout`の`cols` propが更新されることを確認
- **Row Height (px)の反映**
    - `Grid3DControls`でRow Heightを変更
    - `Grid3DLayoutRenderer`の`ReactGridLayout`の`rowHeight` propが更新されることを確認
- **Borderedの反映**
    - `Grid3DControls`でBorderedをトグル
    - `Grid3DLayoutRenderer`の`layout.bordered`が更新されることを確認
    - DOM要素の`grid-bordered`クラスが適用/削除されることを確認

#### テスト実装の詳細

- **テストライブラリ**: Vitest + React Testing Library
- **モック**: Three.js、SceneManager、CellCSS2DServiceをモック
- **参照**: 既存のテストファイル（`grid-3d-layout-renderer.test.tsx`、`edit-app-3d-controls.test.tsx`）のパターンに従う

## 実装ファイル

- **修正**: `src/core/edit-app.tsx`（`Grid3DRenderer`に渡す`layout`の生成ロジックを変更）
- **新規作成**: `src/components/editor/renderers/3d-layout/__tests__/grid-3d-config-integration.test.tsx`（既存のテストファイルを修正）

## テスト実行コマンド

```powershell
pnpm test src/components/editor/renderers/3d-layout/__tests__/grid-3d-config-integration.test.tsx
```



## 注意事項