---
name: 仮想環境管理の実装
overview: backcastアプリでPython環境検出の問題を解決するため、専用仮想環境を自動作成・管理する機能を実装します。仮想環境はアプリ内フォルダ（serverディレクトリ）に配置し、起動時に自動的に作成・検証します。
todos: []
---

# 仮想環境管理の実装

## 概要

`server-manager.js`に仮想環境の自動作成・管理機能を追加し、「kernel not found」エラーを解決します。仮想環境はアプリ内フォルダ（`server`ディレクトリ）に配置し、起動時に存在しない場合は自動的に作成します。

## 実装内容

### 1. パス管理の拡張

**ファイル**: `electron/utils/paths.js`

- `getVenvDir()`関数を追加：`server`ディレクトリ内の`python-env`パスを返す（`{serverDir}/python-env`）
- `getVenvPythonPath()`関数を追加：仮想環境内のPython実行ファイルパスを返す
- Windows: `{serverDir}/python-env/Scripts/python.exe`
- その他: `{serverDir}/python-env/bin/python3`

### 2. 仮想環境管理機能の追加

**ファイル**: `server/server-manager.js`以下の機能を追加：

#### 2.1 システムPythonの検出

- `findSystemPython()`メソッドを追加
- 仮想環境作成用にシステムPythonを環境変数から検出（埋め込みランタイムは除外）
- 検出優先順位：
  1. `PYTHON`環境変数（直接パス）
  2. `PYTHON_HOME`環境変数（ディレクトリ + `python.exe`/`python3`）
  3. `PATH`環境変数（WindowsAppsを除外）
  4. フォールバック（`python.exe`/`python3`を直接実行、WindowsAppsを検出して警告）
- 各パスで実行可能性を検証（`--version`で確認）
- `findPythonExecutable()`とは独立して実装

#### 2.2 仮想環境の作成

- `createVirtualEnvironment(systemPythonPath, venvPath)`メソッド
- `spawn()`を使用して`python -m venv <venvPath>`を実行
- 非同期処理で進捗をログ出力
- Windows環境でのパス処理に対応
- タイムアウト設定（60秒）
- 作成失敗時はエラーをthrow

#### 2.3 仮想環境の検証

- `ensureVirtualEnvironment()`メソッド
- 仮想環境ディレクトリの存在確認
- **仮想環境が存在する場合：システムPythonの検索をスキップし、既存の仮想環境を使用**
- 仮想環境内のPython実行ファイルの存在確認
- Python実行ファイルが存在しない、または実行できない場合は破損と判断
- 破損時は既存の仮想環境を削除して再作成
- **存在しない場合のみ**`findSystemPython()`でシステムPythonを取得し、`createVirtualEnvironment()`で作成
- 作成後、`waitForFile()`でPython実行ファイルの作成を待機（最大5秒、500ms間隔）
- 作成成功後、`installDependencies()`を呼び出して依存関係をインストール
- 戻り値：`true`（作成された場合）/`false`（既に存在した場合）

#### 2.4 依存関係のインストール

- `installDependencies(venvPythonPath)`メソッド
- 仮想環境内のpipを使用して`pip install -r requirements.txt`を実行
- `spawn()`を使用して非同期処理
- インストールプロセスのログ出力（stdout/stderrをキャプチャ）
- タイムアウト設定（300秒）
- インストール失敗時はエラーをthrow
- 注意：`ensureVirtualEnvironment()`内で初回作成時のみ呼び出し（既存環境では呼び出さない）

#### 2.5 Python実行ファイル検出の更新

- `findPythonExecutable()`メソッドを更新
- 優先順位：仮想環境内のPython → 埋め込みランタイム → システムPython
- 仮想環境が存在する場合は、`getVenvPythonPath()`で取得したパスを優先的に使用
- 仮想環境内のPythonが存在しない、または実行できない場合は次の優先順位にフォールバック
- フォールバック時は警告ログを出力
- **注意**: `start()`メソッドでは、`ensureVirtualEnvironment()`後に仮想環境が存在することが保証されるため、フォールバックは発生しない

#### 2.6 marimoチェックの更新

- `checkMarimoInstalled()`メソッドを更新
- 仮想環境内のPythonを使用してmarimoのインストールを確認
- 未インストールの場合は`pip install -r requirements.txt`を実行（`installDependencies()`を呼び出し）
- インストール失敗時はエラーをthrow（フォールバックなし）

### 3. 起動フローの更新

**ファイル**: `server/server-manager.js`の`start()`メソッド

起動フローを以下のように更新：

1. 仮想環境の確保（`ensureVirtualEnvironment()`）
   - 仮想環境が存在しない場合：`findSystemPython()`でシステムPythonを検索 → 作成 → 依存関係もインストール
   - 仮想環境が既に存在する場合：システムPythonの検索をスキップ → 既存の仮想環境を使用
   - 仮想環境が破損している場合：削除 → 再作成

2. 仮想環境内のPython実行ファイルを取得（`getVenvPythonPath()`）
   - `ensureVirtualEnvironment()`後に仮想環境が存在することが保証される
   - 実行可能性を検証（`--version`で確認）
   - 失敗時はエラーをthrow（フォールバックなし）

3. marimoのインストール確認（`checkMarimoInstalled()`）
   - 仮想環境が作成された直後の場合：依存関係は既にインストール済みのはず
   - 未インストールの場合：`installDependencies()`を呼び出し
   - インストール失敗時はエラーをthrow

4. サーバーの起動（既存のロジックを使用）

**注意**: 
- 依存関係のインストールは`ensureVirtualEnvironment()`内で初回作成時のみ実行
- 既存環境では`checkMarimoInstalled()`で必要に応じて実行
- 仮想環境が存在する場合は、システムPythonの検索をスキップして起動が高速化される

## 実装の詳細

### 仮想環境パス

- Windows: `{serverDir}/python-env/Scripts/python.exe`
- その他: `{serverDir}/python-env/bin/python3`

### エラーハンドリング

#### 仮想環境作成失敗時

- エラーログを出力し、ステータスを`error`に設定
- システムPythonが見つからない場合は明確なエラーメッセージを表示
- フォールバックなし（仮想環境が必須）

#### 依存関係インストール失敗時

- エラーログを出力し、ステータスを`error`に設定
- 再試行なし（手動での修正を促す）
- 既存の再起動ロジックは維持（`handleServerCrash()`は引き続き動作）

#### 仮想環境破損時

- 既存の仮想環境を削除して再作成
- 再作成も失敗した場合はエラーとして処理

#### 仮想環境内Pythonが使用できない場合

- エラーをthrow（`ensureVirtualEnvironment()`で検証済みのため、通常は発生しない）
- フォールバックなし（仮想環境が必須）

### ログ出力

- 仮想環境の作成・検証・依存関係インストールの各ステップで適切なログレベルで出力
- 既存の`logInfo`, `logWarn`, `logError`, `logDebug`を使用

## 影響範囲

- `server/server-manager.js`: 主要な変更
- `electron/utils/paths.js`: パス取得関数の追加
- `.gitignore`: 仮想環境ディレクトリ（`server/python-env/`）とPythonキャッシュファイル（`*.pyc`, `__pycache__/`）を追加
- 既存のAPI（`getStatus()`, `getLogs()`など）は変更なし

## 実装の詳細（技術仕様）

### 仮想環境作成プロセス

1. 仮想環境が存在しない場合のみ実行
2. `findSystemPython()`でシステムPythonを環境変数から検出
   - `PYTHON`環境変数を最優先
   - `PYTHON_HOME`環境変数を次に検索
   - `PATH`環境変数から検索（WindowsAppsを除外）
   - フォールバック（WindowsAppsを検出して警告）
3. `spawn()`で`python -m venv <venvPath>`を実行
4. プロセスの完了を待機（最大60秒）
5. `waitForFile()`でPython実行ファイルの作成を待機（最大5秒、500ms間隔）
6. 作成成功後、`installDependencies()`を呼び出し

### 依存関係インストールプロセス

1. `spawn()`で`<venvPythonPath> -m pip install -r requirements.txt`を実行
2. stdout/stderrをキャプチャしてログ出力
3. プロセスの完了を待機（最大300秒）
4. インストール成功を確認

### 仮想環境検証プロセス

1. `getVenvDir()`で仮想環境ディレクトリの存在確認
2. **存在する場合：システムPythonの検索をスキップし、既存の仮想環境を使用**
3. **存在しない場合：`findSystemPython()`でシステムPythonを検索して作成**
4. `getVenvPythonPath()`でPython実行ファイルの存在確認
5. Python実行ファイルが存在する場合、`--version`を実行して動作確認
6. いずれかが失敗した場合は破損と判断し、再作成

## テスト観点

- 仮想環境が存在しない場合の自動作成（システムPython検索あり）
- 仮想環境が既に存在する場合の再利用（システムPython検索なし、高速化）
- 仮想環境が破損している場合の再作成
- システムPythonが見つからない場合のエラーハンドリング
  - `PYTHON`環境変数が設定されていない場合
  - `PYTHON_HOME`環境変数が設定されていない場合
  - `PATH`にPythonが存在しない場合
  - WindowsAppsのリダイレクトが検出された場合
- 依存関係インストールの成功・失敗ケース
- 仮想環境作成後のPython実行ファイル待機処理
- `.gitignore`による仮想環境の除外確認